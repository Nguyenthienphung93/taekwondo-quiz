{% extends "base.html" %}

{% block title %}TÃ i khoáº£n{% endblock %}

{% block content %}
<div class="account-page">
  <div class="account-card">

    <div class="account-title">

      <div class="card" style="max-width:720px;margin:0 auto;">
        <h2 style="margin-top:0;">ğŸ‘¤ TÃ i Khoáº£n</h2>
      </div>

      <form method="POST" action="{{ url_for('account') }}">
        <div class="account-field-title">
          <label style="font-weight:700;display:block;margin:10px 0 6px;">
            1) TÃªn hiá»ƒn thá»‹ (Nickname)
          </label>
          </div>
        <input
          type="text"
          name="nickname"
          value="{{ current_user.nickname or current_user.username }}"
          placeholder="Nháº­p tÃªn hiá»ƒn thá»‹..."
          style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;"
        >

        <hr style="margin:18px 0;border:none;border-top:1px solid #eee;">
        <div class="account-field-title">
          <label style="font-weight:700;display:block;margin:10px 0 6px;">
            3) Email
          </label>
        </div>

        <div style="display:flex;gap:10px;align-items:center;">
          <input
            type="text"
            value="{{ current_user.email }}"
            disabled
            style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;"
          >
          <button
            type="button"
            class="admin-btn ui-btn--gray"
            id="btnOpenEmail"
          >
            âœï¸ Äá»•i email
          </button>

        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #eee;">
        <div class="account-field-title">
          <label style="font-weight:700;display:block;margin:10px 0 6px;">
            2) Máº­t kháº©u
          </label>
        </div>

        <div style="display:flex;gap:10px;align-items:center;">
          <input
            type="password"
            value="********"
            disabled
            style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;"
          >
          <button
            type="button"
            class="admin-btn ui-btn--gray"
            id="btnOpenPw"
          >
            ğŸ”’ Äá»•i máº­t kháº©u
          </button>

        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:18px;">
          {% if not force_pw %}
          <a class="admin-btn ui-btn--gray" href="{{ url_for('sets') }}">â† Quay láº¡i</a>
          {% endif %}
          <button class="btn-save" type="submit">ğŸ’¾ LÆ°u</button>
        </div>

        {% with msgs = get_flashed_messages(with_categories=true) %}
          {% if msgs %}
            <div style="margin-top:12px;">
              {% for cat, msg in msgs %}
                {% if cat in ["success","danger"] %}
                  <div class="alert {{cat}}">{{ msg }}</div>
                {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </form>
    </div>
  </div>
</div>

<!-- ===== MODAL Äá»”I Máº¬T KHáº¨U ===== -->
<div id="pwModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="pwBackdrop"></div>

  <div class="modal-box" style="max-width:520px;">
    <div class="ui-modal-header">
      <div style="font-weight:700;font-size:18px;">ğŸ”‘ Äá»•i máº­t kháº©u</div>
      {% if not force_pw %}
      <button class="icon-btn" id="pwClose">âœ–</button>
      {% endif %}
    </div>

    <form method="POST" action="{{ url_for('account_change_password') }}" class="modal-body">
      <div class="form-row">
        <label>Máº­t kháº©u hiá»‡n táº¡i</label>
        <div class="pw-wrap">
          <input type="password" name="current_password" id="pwCur" required>
          <button class="eye-btn" type="button" data-target="pwCur">ğŸ™‚</button>
        </div>
      </div>

      <div class="form-row">
        <label>Máº­t kháº©u má»›i</label>
        <div class="pw-wrap">
          <input type="password" name="new_password" id="pwNew" required>
          <button class="eye-btn" type="button" data-target="pwNew">ğŸ™‚</button>
        </div>
      </div>

      <div class="form-row">
        <label>Nháº­p láº¡i máº­t kháº©u</label>
        <div class="pw-wrap">
          <input type="password" name="re_password" id="pwRe" required>
          <button class="eye-btn" type="button" data-target="pwRe">ğŸ™‚</button>
        </div>
      </div>

      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% for cat, msg in msgs %}
          {% if cat == "danger_pw" %}<div class="pw-error">{{ msg }}</div>{% endif %}
          {% if cat == "success_pw" %}<div class="pw-success">{{ msg }}</div>{% endif %}
        {% endfor %}
      {% endwith %}

      <div class="modal-footer">
        {% if not force_pw %}
        <button class="admin-btn ui-btn--gray" type="button" id="pwClose2">ÄÃ³ng</button>
        {% endif %}
        <button class="btn-confirm" type="submit">âœ… Äá»•i</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODAL Äá»”I EMAIL ===== -->
<div id="emailModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="emailBackdrop"></div>

  <div class="modal-box" style="max-width:520px;">
    <div class="ui-modal-header">
      <div style="font-weight:700;font-size:18px;">ğŸ“§ Äá»•i email</div>
      <button class="icon-btn" id="emailClose">âœ–</button>
    </div>

    <form method="POST" action="{{ url_for('change_email') }}" class="modal-body">
      <div class="form-row">
        <label>Email má»›i</label>
        <input type="email" name="email" required>
      </div>

      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% for cat, msg in msgs %}
          {% if cat in ["danger_email","success_email"] %}
            <div class="{{ 'email-error' if cat=='danger_email' else 'email-success' }}">{{ msg }}</div>
          {% endif %}
        {% endfor %}
      {% endwith %}

      <div class="modal-footer">
        <button class="admin-btn ui-btn--gray" type="button" id="emailClose2">ÄÃ³ng</button>
        <button class="btn-confirm" type="submit">âœ… Äá»•i</button>
      </div>
    </form>
  </div>
</div>

<script>
  const FORCE_PW = {{ 'true' if force_pw else 'false' }};
  const pwModal = document.getElementById("pwModal");
  const emailModal = document.getElementById("emailModal");

  function openPw(){ pwModal.classList.add("show"); document.body.style.overflow="hidden"; }
  function closePw(){ pwModal.classList.remove("show"); document.body.style.overflow=""; }

  function openEmail(){ emailModal.classList.add("show"); document.body.style.overflow="hidden"; }
  function closeEmail(){ emailModal.classList.remove("show"); document.body.style.overflow=""; }

  document.getElementById("btnOpenEmail")?.addEventListener("click", openEmail);
  document.getElementById("btnOpenPw")?.addEventListener("click", openPw);
  document.getElementById("pwClose")?.addEventListener("click", closePw);
  document.getElementById("pwClose2")?.addEventListener("click", closePw);
  document.getElementById("pwBackdrop")?.addEventListener("click", ()=>{ if(!FORCE_PW) closePw(); });

  document.getElementById("emailClose")?.addEventListener("click", closeEmail);
  document.getElementById("emailClose2")?.addEventListener("click", closeEmail);
  document.getElementById("emailBackdrop")?.addEventListener("click", closeEmail);

  document.querySelectorAll(".eye-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const input = document.getElementById(btn.dataset.target);
      if(!input) return;

      const isHidden = input.type === "password";
      input.type = isHidden ? "text" : "password";
      btn.textContent = isHidden ? "ğŸ˜‘" : "ğŸ™‚";
      input.focus();
    });
  });

  if(document.querySelector(".email-error, .email-success")) openEmail();
  if(document.querySelector(".pw-error, .pw-success") || FORCE_PW) openPw();
</script>

{% endblock %}
