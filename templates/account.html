<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Account</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">
  <div class="card" style="max-width:720px;margin:0 auto;">
    <h2 style="margin-top:0;">ğŸ‘¤ TÃ i Khoáº£n</h2>

    <form method="POST" action="{{ url_for('account') }}">
      <label style="font-weight:700;display:block;margin:10px 0 6px;">
        1) TÃªn hiá»ƒn thá»‹ (Nickname)
      </label>
      <input
        type="text"
        name="nickname"
        value="{{ current_user.nickname or current_user.username }}"
        placeholder="Nháº­p tÃªn hiá»ƒn thá»‹..."
        style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;"
      >
      <div style="font-size:12px;opacity:.75;margin-top:6px;">
      </div>

      <hr style="margin:18px 0;border:none;border-top:1px solid #eee;">

      <label style="font-weight:700;display:block;margin:10px 0 6px;">
        3) Email
      </label>

      <div style="display:flex;gap:10px;align-items:center;">
        <input
          type="text"
          value="{{ current_user.email }}"
          disabled
          style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;"
        >
        <button type="button" class="btn gray" onclick="openEmail()">âœï¸ Äá»•i email</button>
      </div>

      <hr style="margin:18px 0;border:none;border-top:1px solid #eee;">


      <div style="font-size:12px;opacity:.75;margin-top:6px;">
      </div>


      <label style="font-weight:700;display:block;margin:10px 0 6px;">
        2) Máº­t kháº©u
      </label>

      <div style="display:flex;gap:10px;align-items:center;">
        <input
          type="password"
          value="********"
          disabled
          style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f9fafb;"
        >
        <button type="button" class="btn gray" id="btnOpenPw">ğŸ”’ Äá»•i máº­t kháº©u</button>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:18px;">
        {% if not force_pw %}
        <a class="btn gray" href="{{ url_for('sets') }}">â† Quay láº¡i</a>
        {% endif %}
        <button class="btn" type="submit">ğŸ’¾ LÆ°u</button>
      </div>

      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
          <div style="margin-top:12px;">
            {% for cat, msg in msgs %}
              {% if cat in ["success","danger"] %}
                <div class="alert {{cat}}">{{ msg }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </form>
  </div>
</div>


<!-- ===== MODAL Äá»”I Máº¬T KHáº¨U ===== -->
<div id="pwModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="pwBackdrop"></div>

  <div class="modal-box" role="dialog" aria-modal="true" aria-label="Äá»•i máº­t kháº©u" style="max-width:520px;">
    <div class="modal-header">
      <div style="font-weight:700;font-size:18px;">ğŸ”‘ Äá»•i máº­t kháº©u</div>

      {% if not force_pw %}
      <button class="icon-btn" id="pwClose" title="ÄÃ³ng">âœ–</button>
      {% endif %}
    </div>


    <form method="POST" action="{{ url_for('account_change_password') }}" class="modal-body">
      <div class="form-row">
        <label>Máº­t kháº©u hiá»‡n táº¡i</label>
        <div class="pw-wrap">
          <input type="password" name="current_password" id="pwCur" required placeholder="Nháº­p máº­t kháº©u hiá»‡n táº¡i">
          <button class="eye-btn" type="button" data-target="pwCur">ğŸ‘</button>
        </div>
      </div>

      <div class="form-row">
        <label>Máº­t kháº©u má»›i</label>
        <div class="pw-wrap">
          <input type="password" name="new_password" id="pwNew" required placeholder="Nháº­p máº­t kháº©u má»›i">
          <button class="eye-btn" type="button" data-target="pwNew">ğŸ‘</button>
        </div>
      </div>

      <div class="form-row">
        <label>Nháº­p láº¡i máº­t kháº©u</label>
        <div class="pw-wrap">
          <input type="password" name="re_password" id="pwRe" required placeholder="Nháº­p láº¡i máº­t kháº©u má»›i">
          <button class="eye-btn" type="button" data-target="pwRe">ğŸ‘</button>
        </div>
      </div>

      <!-- âœ… hiá»‡n lá»—i ngay trÃªn nÃºt Ä‘á»•i -->
      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
          {% for cat, msg in msgs %}
            {% if cat == "danger_pw" %}
              <div class="pw-error">{{ msg }}</div>
            {% endif %}
            {% if cat == "success_pw" %}
              <div class="pw-success">{{ msg }}</div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="modal-footer" style="gap:10px;">
        {% if not force_pw %}
        <button class="btn gray" type="button" id="pwClose2">ÄÃ³ng</button>
        {% endif %}
        <button class="btn" type="submit">âœ… Äá»•i</button>
      </div>
    </form>
  </div>
</div>

<!-- ===== MODAL Äá»”I EMAIL ===== -->
<div id="emailModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="emailBackdrop"></div>

  <div class="modal-box" role="dialog" aria-modal="true" aria-label="Äá»•i email" style="max-width:520px;">
    <div class="modal-header">
      <div style="font-weight:700;font-size:18px;">ğŸ“§ Äá»•i email</div>
      <button class="icon-btn" id="emailClose" title="ÄÃ³ng">âœ–</button>
    </div>

    <form method="POST" action="{{ url_for('change_email') }}" class="modal-body">
      <div class="form-row">
        <label>Email má»›i</label>
        <input type="email" name="email" required placeholder="Vui lÃ²ng nháº­p email má»›i">
      </div>

      {% with msgs = get_flashed_messages(with_categories=true) %}
        {% if msgs %}
          {% for cat, msg in msgs %}
            {% if cat in ["danger_email","success_email"] %}
              <div class="{{ 'email-error' if cat=='danger_email' else 'email-success' }}">
                {{ msg }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="modal-footer" style="gap:10px;">
        <button class="btn gray" type="button" id="emailClose2">ÄÃ³ng</button>
        <button class="btn" type="submit">âœ… Äá»•i</button>
      </div>
    </form>
  </div>
</div>

<script>
  const FORCE_PW = {{ 'true' if force_pw else 'false' }};

  // ===== open/close modal =====
  const pwModal = document.getElementById("pwModal");
  const btnOpenPw = document.getElementById("btnOpenPw");
  const pwClose = document.getElementById("pwClose");
  const pwClose2 = document.getElementById("pwClose2");
  const pwBackdrop = document.getElementById("pwBackdrop");

  function openPw(){
    pwModal.classList.add("show");
    pwModal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closePw(){
    pwModal.classList.remove("show");
    pwModal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  if(btnOpenPw) btnOpenPw.addEventListener("click", openPw);
  if(pwClose) pwClose.addEventListener("click", closePw);
  if(pwClose2) pwClose2.addEventListener("click", closePw);
  if(pwBackdrop) pwBackdrop.addEventListener("click", ()=>{
    if(!FORCE_PW) closePw();
  });

  document.addEventListener("keydown", (e)=>{
    if(FORCE_PW) return;
    if(e.key === "Escape" && pwModal.classList.contains("show")) closePw();
  });


  // ===== eye toggle =====
  document.querySelectorAll(".eye-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-target");
      const inp = document.getElementById(id);
      if(!inp) return;
      inp.type = (inp.type === "password") ? "text" : "password";
    });
  });

  // ===== EMAIL MODAL =====
  const emailModal = document.getElementById("emailModal");
  const emailBackdrop = document.getElementById("emailBackdrop");
  const emailClose = document.getElementById("emailClose");
  const emailClose2 = document.getElementById("emailClose2");

  function openEmail(){
    emailModal.classList.add("show");
    emailModal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }

  function closeEmail(){
    emailModal.classList.remove("show");
    emailModal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  if(emailClose) emailClose.addEventListener("click", closeEmail);
  if(emailClose2) emailClose2.addEventListener("click", closeEmail);
  if(emailBackdrop) emailBackdrop.addEventListener("click", closeEmail);

  // náº¿u cÃ³ flash email -> tá»± má»Ÿ modal
  const hasEmailMsg = document.querySelector(".email-error, .email-success");
  if(hasEmailMsg && emailModal) openEmail();



  // âœ… náº¿u cÃ³ flash lá»—i Ä‘á»•i máº­t kháº©u -> tá»± báº­t modal cho user tháº¥y lá»—i
  const hasPwError = document.querySelector(".pw-error") || document.querySelector(".pw-success");
  if(hasPwError) openPw();

  // ğŸ” Ã©p Ä‘á»•i máº­t kháº©u sau reset
  if (FORCE_PW) {
    openPw();
  }

</script>

</body>
</html>
