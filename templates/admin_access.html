{% extends "base.html" %}
{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% for category, msg in messages %}
    <div class="toast toast-{{ category }}">
      {{ msg }}
    </div>
  {% endfor %}
{% endwith %}




<h2>üîê C·∫•p quy·ªÅn truy c·∫≠p</h2>
<h4 style="margin-top:5px;color:#666">C√†i ƒë·∫∑t</h4>

<form method="post">

  <!-- ===== MODE SELECT ===== -->
  <div style="margin:15px 0">
    <label>
      <input type="radio" name="mode" value="admin_only"
        {% if mode == "admin_only" %}checked{% endif %}>
      Ch·ªâ Admin
    </label><br>

    <label>
      <input type="radio" name="mode" value="all"
        {% if mode == "all" %}checked{% endif %}>
      M·ªçi ng∆∞·ªùi
    </label><br>

    <label>
      <input type="radio" name="mode" value="custom"
        {% if mode == "custom" %}checked{% endif %}>
      L·ª±a ch·ªçn
    </label>
  </div>

  <!-- ===== CUSTOM AREA ===== -->
  <div id="customBox" style="display:none;gap:20px">

    <!-- ALL USERS -->
    <div style="flex:1">
      <h4>T·∫•t c·∫£ ng∆∞·ªùi d√πng</h4>
      <input type="text" placeholder="üîç T√¨m..."
        onkeyup="filterList(this,'allUsers')">

      <select id="allUsers" multiple size="10" style="width:100%">
        {% for u in users %}
          {% if u.role != "admin" and u.id not in allowed_ids %}
            <option value="{{ u.id }}">
              {{ u.username }} ({{ u.email or "None" }})
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <!-- BUTTONS -->
    <div style="display:flex;flex-direction:column;justify-content:center;gap:10px">
      <button type="button" onclick="move('allUsers','allowedUsers')"> &gt; </button>
      <button type="button" onclick="move('allowedUsers','allUsers')"> &lt; </button>
    </div>

    <!-- ALLOWED USERS -->
    <div style="flex:1">
      <h4>Ng∆∞·ªùi ƒë∆∞·ª£c ph√©p</h4>
      <input type="text" placeholder="üîç T√¨m..."
        onkeyup="filterList(this,'allowedUsers')">

      <select id="allowedUsers" name="allowed_users" multiple size="10" style="width:100%">
        {% for u in users %}
          {% if u.id in allowed_ids %}
            <option value="{{ u.id }}"
              {% if u.role == "admin" %}disabled{% endif %}>
              {{ u.username }} ({{ u.email or "None" }})
              {% if u.role == "admin" %} üîí Admin{% endif %}
            </option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

  </div>


  <div style="margin-top:20px">
    <button class="btn">üíæ L∆∞u</button>
  </div>

</form>

<script>
function move(from,to){
  const f = document.getElementById(from)
  const t = document.getElementById(to)
  Array.from(f.selectedOptions).forEach(o=>{
    if (!o.disabled) {
      t.appendChild(o)
    }
  })
}

function filterList(input,id){
  const kw = input.value.toLowerCase()
  const sel = document.getElementById(id)
  Array.from(sel.options).forEach(o=>{
    o.style.display = o.text.toLowerCase().includes(kw) ? "" : "none"
  })
}

function toggleBox(){
  const mode = document.querySelector("input[name='mode']:checked").value
  const box = document.getElementById("customBox")
  box.style.display = (mode === "custom") ? "flex" : "none"
}

document.querySelectorAll("input[name='mode']").forEach(r=>{
  r.addEventListener("change", toggleBox)
})
toggleBox()
</script>

{% endblock %}
