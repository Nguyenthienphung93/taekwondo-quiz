{% extends "base.html" %}
{% block content %}

<div class="layout-container">
  <div class="result-wrapper">
    <div class="result-page-card">

      <div class="result-title">
        ğŸ‰ Xin chÃºc má»«ng báº¡n Ä‘Ã£ Ä‘áº¡t
      </div>

      <div class="result-score">
        {{ score }} / {{ total }}
      </div>

      <div class="result-sub">
        cÃ¢u tráº£ lá»i Ä‘Ãºng
      </div>

      <!-- ===== ACTION BUTTONS ===== -->
      <div class="result-actions">

        <div class="action-row">
          <button id="btnReplay" class="result-btn result-btn--replay">
            ğŸ” ChÆ¡i láº¡i
          </button>

          <button id="btnReview" class="result-btn result-btn--review">
            ğŸ” Kiá»ƒm tra
          </button>
        </div>

        <div class="action-row single">
          <a href="{{ url_for('sets') }}" class="result-btn result-btn--home">
            ğŸ  Vá» trang chÃ­nh
          </a>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}

<!-- ================== REVIEW MODAL ================== -->
<div id="reviewModal" class="ui-modal-backdrop">
  <div class="ui-modal-box">

    <div class="ui-modal-header">
      <div style="font-weight:700;font-size:18px;">ğŸ“Œ Kiá»ƒm tra Ä‘Ã¡p Ã¡n</div>
      <button class="icon-btn" id="btnClose">âœ–</button>
    </div>

    <div class="ui-modal-body">
      {% for q, chosen, correct, is_correct in review %}
        <div class="review-card">

          <div class="review-q">
            CÃ¢u {{ loop.index }}: {{ q.text }}
          </div>

          <div class="review-choices">
            {% for c in q.choices %}
              <div class="choice-line">
                {% if chosen and c.id == chosen.id %}
                  <span class="badge-chosen">Báº¡n chá»n</span>
                {% endif %}
                {{ c.text }}
                {% if c.is_correct %}
                  <span class="badge-correct">ÄÃºng</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          {% if not is_correct %}
            <div class="review-wrong">
              âŒ Báº¡n chá»n:
              <b>{{ chosen.text if chosen else "KhÃ´ng chá»n (háº¿t giá»)" }}</b>
            </div>
            <div class="review-correct">
              âœ… ÄÃ¡p Ã¡n Ä‘Ãºng:
              <b>{{ correct.text if correct else "ChÆ°a cÃ³ Ä‘Ã¡p Ã¡n Ä‘Ãºng" }}</b>
            </div>
          {% else %}
            <div class="review-ok">âœ… Tráº£ lá»i Ä‘Ãºng</div>
          {% endif %}

        </div>
      {% endfor %}
    </div>

    <div class="ui-modal-footer">
      <button class="ui-btn ui-btn--gray" id="btnClose2">ÄÃ³ng</button>
    </div>

  </div>
</div>

<!-- ================== REPLAY MODAL ================== -->
<div id="replayModal" class="ui-modal-backdrop">
  <div class="ui-modal-box">

    <div class="ui-modal-header">
      <div style="font-weight:800;">ğŸ¯ Báº¯t Ä‘áº§u Ã´n táº­p</div>
      <button class="icon-btn" id="btnReplayClose">âœ–</button>
    </div>

    <div class="ui-modal-body" style="text-align:center;">
      <h2 style="margin:12px 0 20px;">
        {{ topic_name }}
      </h2>

      <a class="ui-btn ui-btn--primary" href="{{ replay_url }}">
        â–¶ Báº®T Äáº¦U
      </a>
    </div>

  </div>
</div>

<!-- ================== EFFECTS ================== -->

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<audio id="soundFirework" src="/static/sounds/firework.mp3" preload="auto"></audio>
<audio id="soundClap" src="/static/sounds/Clap.mp3" preload="auto"></audio>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ğŸ”¥ Äáº¨Y MODAL RA NGOÃ€I LAYOUT */
  const root = document.getElementById("modal-root");
  ["reviewModal", "replayModal"].forEach(id => {
    const m = document.getElementById(id);
    if (m && root) root.appendChild(m);
  });

  /* ===== MODAL CONTROL ===== */
  const reviewModal = document.getElementById("reviewModal");
  const replayModal = document.getElementById("replayModal");

  document.getElementById("btnReview").onclick = () => openModal(reviewModal);
  document.getElementById("btnReplay").onclick = () => openModal(replayModal);

  document.getElementById("btnClose").onclick =
  document.getElementById("btnClose2").onclick = () => closeModal(reviewModal);

  document.getElementById("btnReplayClose").onclick = () => closeModal(replayModal);

  function openModal(m){
    m.classList.add("show");
    document.body.style.overflow = "hidden";
  }

  function closeModal(m){
    m.classList.remove("show");
    document.body.style.overflow = "";
  }

  /* ===== CONFETTI + SOUND ===== */
  confetti({
    particleCount: 160,
    spread: 90,
    origin: { y: 0.6 }
  });

  const end = Date.now() + 2200;
  (function frame(){
    confetti({ particleCount: 6, angle: 60, spread: 70, origin:{x:0} });
    confetti({ particleCount: 6, angle:120, spread: 70, origin:{x:1} });
    if (Date.now() < end) requestAnimationFrame(frame);
  })();

  const firework = document.getElementById("soundFirework");
  const clap = document.getElementById("soundClap");

  firework.currentTime = 0;
  clap.currentTime = 0;

  firework.play().catch(()=>{});
  clap.play().catch(()=>{});
});
</script>

{% endblock %}
