{% extends "base.html" %}
{% block content %}

<div class="result-wrapper">

  <div class="result-card">

    <div class="result-title">
      üéâ Xin ch√∫c m·ª´ng b·∫°n ƒë√£ ƒë·∫°t
    </div>

    <div class="result-score">
      {{ score }} / {{ total }}
    </div>

    <div class="result-sub">
      c√¢u tr·∫£ l·ªùi ƒë√∫ng
    </div>

    <!-- ===== ACTION BUTTONS ===== -->
    <div class="result-actions">

      <!-- H√ÄNG 1: CH∆†I L·∫†I + KI·ªÇM TRA -->
      <div class="action-row">
        <button class="btn-replay" type="button" id="btnReplay">
          üîÅ Ch∆°i l·∫°i
        </button>

        <button class="btn-review" type="button" id="btnReview">
          üîé Ki·ªÉm tra
        </button>
      </div>

      <!-- H√ÄNG 2: V·ªÄ TRANG CH√çNH -->
      <div class="action-row single">
        <a class="btn-home" href="{{ url_for('sets') }}">
          üè† V·ªÅ trang ch√≠nh
        </a>
      </div>

    </div>


  </div>
</div>

<!-- ===== MODAL REVIEW ===== -->
<div id="reviewModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="closeBackdrop"></div>

  <div class="modal-box">
    <div class="modal-header">
      <div style="font-weight:700;font-size:18px;">üìå Ki·ªÉm tra ƒë√°p √°n</div>
      <button class="icon-btn" id="btnClose">‚úñ</button>
    </div>

    <div class="modal-body">
      {% for q, chosen, correct, is_correct in review %}
        <div class="review-card">
          <div class="review-q">
            C√¢u {{ loop.index }}: {{ q.text }}
          </div>

          <div class="review-choices">
            {% for c in q.choices %}
              <div class="choice-line">
                {% if chosen and c.id == chosen.id %}
                  <span class="badge-chosen">B·∫°n ch·ªçn</span>
                {% endif %}
                {{ c.text }}
                {% if c.is_correct %}
                  <span class="badge-correct">ƒê√∫ng</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          {% if not is_correct %}
            <div class="review-wrong">
              ‚ùå B·∫°n ch·ªçn:
              <b>{{ chosen.text if chosen else "Kh√¥ng ch·ªçn (h·∫øt gi·ªù)" }}</b>
            </div>
            <div class="review-correct">
              ‚úÖ ƒê√°p √°n ƒë√∫ng:
              <b>{{ correct.text if correct else "Ch∆∞a c√≥ ƒë√°p √°n ƒë√∫ng" }}</b>
            </div>
          {% else %}
            <div class="review-ok">‚úÖ Tr·∫£ l·ªùi ƒë√∫ng</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <div class="modal-footer">
      <button class="btn-main" id="btnClose2">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- ===== MODAL REPLAY ===== -->
<div id="replayModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" id="replayBackdrop"></div>

  <div class="modal-box">
    <div class="modal-header">
      <div style="font-weight:800;">üéØ B·∫Øt ƒë·∫ßu √¥n t·∫≠p</div>
      <button class="icon-btn" id="btnReplayClose">‚úñ</button>
    </div>

    <div class="modal-body" style="text-align:center;">
      <h2 style="margin:12px 0 20px;">
        {{ topic_name }}
      </h2>

      <a class="btn-main" href="{{ replay_url }}">
        ‚ñ∂ B·∫ÆT ƒê·∫¶U
      </a>
    </div>
  </div>
</div>

<!-- üéÜ CONFETTI -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<!-- üëè CLAP SOUND -->
<audio id="clapSound">
  <source src="{{ url_for('static', filename='Clap.mp3') }}" type="audio/mpeg">
</audio>

<script>
  /* ===== REVIEW MODAL ===== */
  const modal = document.getElementById("reviewModal");
  const btnReview = document.getElementById("btnReview");
  const btnClose = document.getElementById("btnClose");
  const btnClose2 = document.getElementById("btnClose2");
  const backdrop = document.getElementById("closeBackdrop");

  function openModal(){
    modal.classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    modal.classList.remove("show");
    document.body.style.overflow = "";
  }

  btnReview.onclick = () => {
    setTimeout(() => {
      const sound = document.getElementById("clapSound");
      if (sound) {
        sound.currentTime = 0;
        sound.play().catch(()=>{});
      }
    }, 2000);
    openModal();
  };

  btnClose.onclick = closeModal;
  btnClose2.onclick = closeModal;
  backdrop.onclick = closeModal;

  /* ===== REPLAY MODAL ===== */
  const replayModal = document.getElementById("replayModal");
  const btnReplay = document.getElementById("btnReplay");
  const btnReplayClose = document.getElementById("btnReplayClose");
  const replayBackdrop = document.getElementById("replayBackdrop");

  function openReplay(){
    replayModal.classList.add("show");
    document.body.style.overflow = "hidden";
  }
  function closeReplay(){
    replayModal.classList.remove("show");
    document.body.style.overflow = "";
  }

  btnReplay.onclick = openReplay;
  btnReplayClose.onclick = closeReplay;
  replayBackdrop.onclick = closeReplay;

  /* ===== CONFETTI ===== */
  const duration = 2600;
  const end = Date.now() + duration;
  (function frame(){
    confetti({ particleCount: 6, angle: 60, spread: 70, origin:{x:0} });
    confetti({ particleCount: 6, angle:120, spread: 70, origin:{x:1} });
    if(Date.now() < end) requestAnimationFrame(frame);
  })();
</script>

{% endblock %}
