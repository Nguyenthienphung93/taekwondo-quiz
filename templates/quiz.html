{% extends "base.html" %}
{% block title %}L√†m b√†i{% endblock %}

{% block content %}

<div class="layout-container">

  <div class="quiz-page-wrapper">

    <!-- üîπ CH·ª¶ ƒê·ªÄ -->
    <div class="quiz-topic">
      <div class="quiz-topic-label">Ch·ªß ƒë·ªÅ</div>
      <div class="quiz-topic-name">
        {{ question.folder.name if question.folder else "√în t·∫≠p" }}
      </div>
    </div>

    <!-- üîπ KHUNG GAME -->
    <div class="quiz-card">

      <!-- üîπ C√ÇU S·ªê / T·ªîNG -->
      <div class="quiz-progress">
        C√¢u {{ progress[0] + 1 }} / {{ progress[1] }}
      </div>

      <!-- üîπ TIMER -->
      {% if time_per_q %}
      <div class="quiz-top-center">
        <div class="timer-inline">

          <div class="timer-ring timer-safe" id="timerRing">
            <svg width="72" height="72">
              <circle class="bg"
                      cx="36" cy="36" r="32"
                      stroke-width="6"
                      fill="none"/>
              <circle class="progress"
                      cx="36" cy="36" r="32"
                      stroke-width="6"
                      stroke-linecap="round"
                      fill="none"/>
            </svg>
            <div id="timer">{{ time_per_q }}</div>
          </div>

          <div class="timer-unit">gi√¢y</div>
        </div>
      </div>
      {% endif %}

      <!-- ‚ùì C√ÇU H·ªéI -->
      <div class="quiz-question">
        {{ question.text }}
      </div>

      <!-- üéØ ƒê√ÅP √ÅN -->
      <form method="POST" id="quiz-form">
        <div class="answers-grid">
          {% for c in question.choices %}
          <label class="quiz-answer-btn">
            <input type="radio" name="choice_id" value="{{ c.id }}">
            <span>{{ ['A','B','C','D'][loop.index0] }}. {{ c.text }}</span>
          </label>
          {% endfor %}
        </div>

        <!-- ‚ñ∂Ô∏è TI·∫æP THEO -->
        <div class="next-btn-box">
          <button type="button" class="next-btn" id="btnNext">
            Ti·∫øp theo
          </button>
        </div>
      </form>

    </div>
  </div>

</div>

<!-- ===============================
     BEEP SOUND (FILE)
     =============================== -->
<audio id="beepSound" src="/static/sounds/beep.mp3" preload="auto"></audio>

<script>
/* ===== NEXT BUTTON ===== */
const nextBtn  = document.getElementById("btnNext");
const quizCard = document.querySelector(".quiz-card");
const quizForm = document.getElementById("quiz-form");

function showToast(msg){
  const t = document.createElement("div");
  t.className = "ui-toast ui-toast--danger";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

nextBtn.addEventListener("click", () => {
  const checked = quizForm.querySelector("input[name='choice_id']:checked");
  if (!checked) {
    showToast("‚ö†Ô∏è B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n!");
    return;
  }
  quizCard.classList.add("fade-out");
  setTimeout(() => quizForm.submit(), 350);
});
</script>

{% if time_per_q %}
<!-- ===============================
     TIMER + BEEP (KH√îNG ƒê∆†)
     =============================== -->
<script>
let timeLeft = {{ time_per_q }};
const total = timeLeft;

const timerEl   = document.getElementById("timer");
const timerRing = document.getElementById("timerRing");
const progress  = document.querySelector(".timer-ring .progress");

const beepSound = document.getElementById("beepSound");
let beeped = new Set(); // ‚õî ch·∫∑n beep tr√πng

const RADIUS = 32;
const CIRCUMFERENCE = 2 * Math.PI * RADIUS;
progress.style.strokeDasharray = CIRCUMFERENCE;

// reset ban ƒë·∫ßu
timerRing.className = "timer-ring timer-safe";
progress.style.strokeDashoffset = 0;
timerEl.textContent = total;

function playBeep(){
  beepSound.currentTime = 0;
  beepSound.play().catch(()=>{});
}

const timerInterval = setInterval(() => {
  timeLeft--;

  timerEl.textContent = timeLeft;
  const offset = CIRCUMFERENCE * (1 - timeLeft / total);
  progress.style.strokeDashoffset = offset;

  // üîä BEEP 5 ‚Üí 1 (m·ªói gi√¢y 1 l·∫ßn ‚Äì KH√îNG ƒê∆†)
  if (timeLeft <= 5 && timeLeft > 0 && !beeped.has(timeLeft)) {
    playBeep();
    beeped.add(timeLeft);
  }

  timerRing.classList.remove(
    "timer-safe",
    "timer-warning",
    "timer-danger",
    "timer-warning-ring",
    "timer-danger-ring"
  );

  if (timeLeft > 10) {
    timerRing.classList.add("timer-safe");
  }
  else if (timeLeft > 5) {
    timerRing.classList.add("timer-warning", "timer-warning-ring");
  }
  else {
    timerRing.classList.add("timer-danger", "timer-danger-ring");
  }

  if (timeLeft <= 0) {
    clearInterval(timerInterval);
    quizForm.submit();
  }
}, 1000);
</script>
{% endif %}

{% endblock %}
