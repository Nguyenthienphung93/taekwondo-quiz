<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Danh s√°ch c√¢u h·ªèi</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal-backdrop.show{ display:flex; }
    .modal-box{
      width:min(760px, 100%);
      background:#fff;
      border-radius:14px;
      box-shadow:0 12px 40px rgba(0,0,0,.2);
      overflow:hidden;
    }

    /* ==== FIX LABEL CANH TR√ÅI CHO MODAL ==== */
    .modal-admin label{
      text-align: left;
    }


    .modal-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid #eee;
    }
    .modal-title{ font-size:18px; font-weight:700; }
    .modal-close{
      border:none; background:transparent;
      font-size:22px; cursor:pointer; line-height:1;
    }
    .modal-body{ padding:16px; }
    .modal-footer{
      display:flex; gap:10px; justify-content:flex-end;
      padding:14px 16px;
      border-top:1px solid #eee;
    }
    .form-row{ margin-bottom:12px; }
    .form-row label{ display:block; font-weight:600; margin-bottom:6px; }
    .form-row input, .form-row textarea, .form-row select{
      width:100%;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:10px;
      outline:none;
    }
    .form-row textarea{ resize:vertical; }
    .correct-wrap{
      display:flex; gap:18px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid #ddd;
      border-radius:10px;
    }
    .hint{ font-size:13px; opacity:.8; margin-top:6px; }
    .rowline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .rowline .title{
      width:92px;
      font-weight:700;
      opacity:.9;
    }
    .rowline .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .rowline select{ min-width: 340px; max-width: 520px; }
    @media (max-width: 720px){
      .rowline .title{ width:auto; }
      .rowline select{ min-width: 100%; max-width: 100%; }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>üõ†Ô∏è Admin - T·∫°o C√¢u H·ªèi </h1>
    <div>
      <a class="btn gray" href="/sets">Trang ch√≠nh</a>
    </div>
  </div>


  <!-- ‚úÖ Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div style="margin-top:12px;">
        {% for category, message in messages %}
          <div class="alert {{category}}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card">
    <h3>H√£y ch·ªçn ch·ªß ƒë·ªÅ!</h3>

    <!-- ====== C·∫§P 1 ====== -->
    <div class="rowline">
      <div class="title">Ch·ªß ƒë·ªÅ 1:</div>

      <form method="GET" action="/admin/questions" style="flex:1;min-width:260px;">
        <select name="folder1_id" required onchange="this.form.submit()">
          {% for f in folder1_list %}
            <option value="{{f.id}}" {% if selected_folder1 and selected_folder1.id==f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>

        {% if selected_folder2 %}<input type="hidden" name="folder2_id" value="{{selected_folder2.id}}">{% endif %}
        {% if selected_folder3 %}<input type="hidden" name="folder3_id" value="{{selected_folder3.id}}">{% endif %}
      </form>

      <div class="actions">
        <a class="btn gray" href="#" id="btnOpenAddF1">‚ûï Th√™m</a>
        {% if selected_folder1 %}
          <a class="btn gray" href="#" id="btnOpenEditF1">‚úèÔ∏è S·ª≠a</a>
          <form method="POST" action="/admin/folder/{{selected_folder1.id}}/delete" style="display:inline;"
                onsubmit="return confirm('Xo√° Ch·ªß ƒë·ªÅ 1? (Ch·ªâ xo√° khi KH√îNG c√≤n Ch·ªß ƒë·ªÅ 2)');">
            <button class="btn gray" type="submit">üóëÔ∏è Xo√°</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- ====== C·∫§P 2 ====== -->
    <div class="rowline">
      <div class="title">Ch·ªß ƒë·ªÅ 2:</div>

      <form method="GET" action="/admin/questions" style="flex:1;min-width:260px;">
        <input type="hidden" name="folder1_id" value="{{selected_folder1.id if selected_folder1 else ''}}">
        <select name="folder2_id" required onchange="this.form.submit()">
          {% for f in folder2_list %}
            <option value="{{f.id}}" {% if selected_folder2 and selected_folder2.id==f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>

        {% if selected_folder3 %}<input type="hidden" name="folder3_id" value="{{selected_folder3.id}}">{% endif %}
      </form>

      <div class="actions">
        <a class="btn gray" href="#" id="btnOpenAddF2">‚ûï Th√™m</a>
        {% if selected_folder2 %}
          <a class="btn gray" href="#" id="btnOpenEditF2">‚úèÔ∏è S·ª≠a</a>
          <form method="POST" action="/admin/folder/{{selected_folder2.id}}/delete" style="display:inline;"
                onsubmit="return confirm('Xo√° Ch·ªß ƒë·ªÅ 2? (Ch·ªâ xo√° khi KH√îNG c√≤n Ch·ªß ƒë·ªÅ 3)');">
            <button class="btn gray" type="submit">üóëÔ∏è Xo√°</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- ====== C·∫§P 3 ====== -->
    <div class="rowline">
      <div class="title">Ch·ªß ƒë·ªÅ 3:</div>

      <form method="GET" action="/admin/questions" style="flex:1;min-width:260px;">
        <input type="hidden" name="folder1_id" value="{{selected_folder1.id if selected_folder1 else ''}}">
        <input type="hidden" name="folder2_id" value="{{selected_folder2.id if selected_folder2 else ''}}">
        <select name="folder3_id" required onchange="this.form.submit()">
          {% for f in folder3_list %}
            <option value="{{f.id}}" {% if selected_folder3 and selected_folder3.id==f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>
      </form>

      <div class="actions">
        <a class="btn gray" href="#" id="btnOpenAddF3">‚ûï Th√™m</a>
        {% if selected_folder3 %}
          <a class="btn gray" href="#" id="btnOpenEditF3">‚úèÔ∏è S·ª≠a</a>
          <form method="POST" action="/admin/folder/{{selected_folder3.id}}/delete" style="display:inline;"
                onsubmit="return confirm('Xo√° Ch·ªß ƒë·ªÅ 3? (Ch·ªâ xo√° khi KH√îNG c√≤n c√¢u h·ªèi)');">
            <button class="btn gray" type="submit">üóëÔ∏è Xo√°</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  {% if selected_folder3 %}
    <div class="question-header">
      <div class="qh-left">
        <h2>üìå {{selected_folder1.name}} ‚Äî {{selected_folder2.name}} ‚Äî {{selected_folder3.name}}</h2>
        <div class="badge">{{ questions|length }} c√¢u</div>
      </div>

      <div class="qh-right">
        <a class="btn" href="#" id="btnOpenAddQuestion">‚ûï Th√™m c√¢u h·ªèi</a>
      </div>
    </div>


    {% for q in questions %}
      <div class="card" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
          <div style="flex:1;">
            <b>#{{ q.id }}</b> ‚Äî {{ q.text }}
          </div>
          <div style="display:flex;gap:8px;">
            <a class="btn" href="/admin/question/{{q.id}}/edit">S·ª≠a</a>
            <form method="POST" action="/admin/question/{{q.id}}/delete"
                  onsubmit="return confirm('Xo√° c√¢u h·ªèi n√†y?');">
              <button class="btn gray" type="submit">Xo√°</button>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>

<!-- ================= MODAL: TH√äM C√ÇU H·ªéI ================= -->
<div class="modal-backdrop" id="modalAddQuestion">
  <div class="modal-box modal-admin" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title">‚ûï Th√™m c√¢u h·ªèi </div>
      <button class="modal-close" type="button" data-close="modalAddQuestion">√ó</button>
    </div>

    <form method="POST" action="/admin/questions">
      <div class="modal-body">
        <input type="hidden" name="folder3_id" value="{{ selected_folder3.id if selected_folder3 else '' }}">
        <!-- ‚úÖ gi·ªØ context -->
        <input type="hidden" name="folder1_id" value="{{ selected_folder1.id if selected_folder1 else '' }}">
        <input type="hidden" name="folder2_id" value="{{ selected_folder2.id if selected_folder2 else '' }}">

        <div class="form-row">
          <label>V·ªã tr√≠ l∆∞u</label>
          <input value="{{selected_folder1.name if selected_folder1 else ''}} ‚Äî {{selected_folder2.name if selected_folder2 else ''}} ‚Äî {{selected_folder3.name if selected_folder3 else ''}}" disabled>
        </div>


        <div class="form-row">
          <label>C√¢u h·ªèi</label>
          <textarea name="question_text" rows="2" placeholder="Nh·∫≠p c√¢u h·ªèi..." required></textarea>
        </div>

        <div class="form-row">
          <label>ƒê√°p √°n A</label>
          <input name="choice1" required>
        </div>
        <div class="form-row">
          <label>ƒê√°p √°n B</label>
          <input name="choice2" required>
        </div>
        <div class="form-row">
          <label>ƒê√°p √°n C</label>
          <input name="choice3" required>
        </div>
        <div class="form-row">
          <label>ƒê√°p √°n D</label>
          <input name="choice4" required>
        </div>

        <div class="form-row">
          <label>Ch·ªçn ƒë√°p √°n ƒë√∫ng</label>
          <div class="correct-wrap" style="justify-content:center;">
            <label><input type="radio" name="correct" value="1" required> A</label>
            <label><input type="radio" name="correct" value="2" required> B</label>
            <label><input type="radio" name="correct" value="3" required> C</label>
            <label><input type="radio" name="correct" value="4" required> D</label>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button class="btn gray" type="button" data-close="modalAddQuestion">Hu·ª∑</button>
        <button class="btn" type="submit">L∆∞u c√¢u h·ªèi</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= MODAL: ADD/EDIT FOLDER (C·∫§P 1/2/3) ================= -->
<div class="modal-backdrop" id="modalFolder">
  <div class="modal-box modal-admin" role="dialog" aria-modal="true">
    <div class="modal-header">
      <div class="modal-title" id="folderModalTitle">üìÅ Folder</div>
      <button class="modal-close" type="button" data-close="modalFolder">√ó</button>
    </div>

    <form method="POST"
          id="folderForm"
          enctype="multipart/form-data">
      <div class="modal-body">
        <input type="hidden" name="level" id="f_level">
        <input type="hidden" name="parent_id" id="f_parent_id">

        <input type="hidden" name="folder1_id" value="{{ selected_folder1.id if selected_folder1 else '' }}">
        <input type="hidden" name="folder2_id" value="{{ selected_folder2.id if selected_folder2 else '' }}">

        <!-- ===== T√äN CH·ª¶ ƒê·ªÄ ===== -->
        <div class="form-row">
          <label>T√™n ch·ªß ƒë·ªÅ</label>
          <input name="name" id="f_name" required>
          <div class="hint" id="f_hint"></div>
        </div>

        <!-- ===== ·∫¢NH ƒê·∫†I DI·ªÜN CH·ª¶ ƒê·ªÄ (M·ªöI) ===== -->
        <div class="form-row">
          <label>·∫¢nh ƒë·∫°i di·ªán ch·ªß ƒë·ªÅ</label>
          <input type="file" name="image" accept="image/*">
          <div class="hint">·∫¢nh vu√¥ng, JPG / PNG. C√≥ th·ªÉ ƒë·ªÉ tr·ªëng.</div>
        </div>
      </div>


      <div class="modal-footer">
        <button class="btn gray" type="button" data-close="modalFolder">Hu·ª∑</button>
        <button class="btn" type="submit">L∆∞u</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openModal(id){
    const m = document.getElementById(id);
    if(m) m.classList.add("show");
  }
  function closeModal(id){
    const m = document.getElementById(id);
    if(m) m.classList.remove("show");
  }

  document.addEventListener("click", (e)=>{
    const closeId = e.target.getAttribute("data-close");
    if(closeId) closeModal(closeId);

    const backdrops = ["modalAddQuestion","modalFolder"];
    for(const id of backdrops){
      const m = document.getElementById(id);
      if(m && e.target === m) closeModal(id);
    }
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      closeModal("modalAddQuestion");
      closeModal("modalFolder");
    }
  });

  const btnOpenAddQuestion = document.getElementById("btnOpenAddQuestion");
  if(btnOpenAddQuestion){
    btnOpenAddQuestion.addEventListener("click", (e)=>{
      e.preventDefault();
      openModal("modalAddQuestion");
      const ta = document.querySelector("#modalAddQuestion textarea[name='question_text']");
      if(ta) setTimeout(()=>ta.focus(), 50);
    });
  }

  const folderModalTitle = document.getElementById("folderModalTitle");
  const folderForm = document.getElementById("folderForm");
  const f_level = document.getElementById("f_level");
  const f_parent_id = document.getElementById("f_parent_id");
  const f_name = document.getElementById("f_name");
  const f_hint = document.getElementById("f_hint");

  function openFolderAdd(level, parentId, titleText, hintText){
    folderModalTitle.textContent = "‚ûï " + titleText;
    folderForm.action = "/admin/folder/add";
    f_level.value = level;
    f_parent_id.value = parentId || "";
    f_name.value = "";
    f_hint.textContent = hintText || "";
    openModal("modalFolder");
    setTimeout(()=>f_name.focus(), 50);
  }

  function openFolderEdit(folderId, currentName, level, parentId, titleText, hintText){
    folderModalTitle.textContent = "‚úèÔ∏è " + titleText;
    folderForm.action = "/admin/folder/" + folderId + "/edit"
      + "?folder1_id={{selected_folder1.id if selected_folder1 else ''}}"
      + "&folder2_id={{selected_folder2.id if selected_folder2 else ''}}"
      + "&folder3_id={{selected_folder3.id if selected_folder3 else ''}}";

    f_level.value = level;
    f_parent_id.value = parentId || "";
    f_name.value = currentName || "";
    f_hint.textContent = hintText || "";

    openModal("modalFolder");
    setTimeout(()=>f_name.focus(), 50);
  }


  const btnOpenAddF1 = document.getElementById("btnOpenAddF1");
  if(btnOpenAddF1){
    btnOpenAddF1.addEventListener("click", (e)=>{
      e.preventDefault();
      openFolderAdd(1, null, "Ch·ªß ƒë·ªÅ 1", "Folder c·∫•p 1 (g·ªëc).");
    });
  }
  const btnOpenEditF1 = document.getElementById("btnOpenEditF1");
  {% if selected_folder1 %}
  if(btnOpenEditF1){
    btnOpenEditF1.addEventListener("click", (e)=>{
      e.preventDefault();
      openFolderEdit(
        {{selected_folder1.id}},
        "{{selected_folder1.name|e}}",
        1,
        null,
        "Ch·ªß ƒë·ªÅ 1",
        "ƒê·ªïi t√™n folder c·∫•p 1."
      );
    });
  }

  {% endif %}

  const btnOpenAddF2 = document.getElementById("btnOpenAddF2");
  if(btnOpenAddF2){
    btnOpenAddF2.addEventListener("click", (e)=>{
      e.preventDefault();
      const parentId = {{selected_folder1.id if selected_folder1 else "null"}};
      openFolderAdd(2, parentId, "Ch·ªß ƒë·ªÅ 2", "Folder c·∫•p 2 (n·∫±m trong Ch·ªß ƒë·ªÅ 1).");
    });
  }
  const btnOpenEditF2 = document.getElementById("btnOpenEditF2");
  {% if selected_folder2 %}
  if(btnOpenEditF2){
    btnOpenEditF2.addEventListener("click", (e)=>{
      e.preventDefault();
      openFolderEdit(
        {{selected_folder2.id}},
        "{{selected_folder2.name|e}}",
        2,
        {{selected_folder1.id}},
        "Ch·ªß ƒë·ªÅ 2",
        "ƒê·ªïi t√™n folder c·∫•p 2."
      );
    });
  }

  {% endif %}

  const btnOpenAddF3 = document.getElementById("btnOpenAddF3");
  if(btnOpenAddF3){
    btnOpenAddF3.addEventListener("click", (e)=>{
      e.preventDefault();
      const parentId = {{selected_folder2.id if selected_folder2 else "null"}};
      openFolderAdd(3, parentId, "Ch·ªß ƒë·ªÅ 3", "Folder c·∫•p 3 (n·∫±m trong Ch·ªß ƒë·ªÅ 2). C√¢u h·ªèi s·∫Ω n·∫±m ·ªü ƒë√¢y.");
    });
  }
  const btnOpenEditF3 = document.getElementById("btnOpenEditF3");
  {% if selected_folder3 %}
  if(btnOpenEditF3){
    btnOpenEditF3.addEventListener("click", (e)=>{
      e.preventDefault();
      openFolderEdit(
        {{selected_folder3.id}},
        "{{selected_folder3.name|e}}",
        3,
        {{selected_folder2.id}},
        "Ch·ªß ƒë·ªÅ 3",
        "ƒê·ªïi t√™n folder c·∫•p 3."
      );
    });
  }
  {% endif %}

</script>

</body>
</html>
