{% extends "base.html" %}
{% block title %}Admin - Táº¡o cÃ¢u há»i{% endblock %}

{% block content %}

<!-- ===== ADMIN PAGE TITLE ===== -->
<div class="admin-page">
  <div class="admin-page-title">ğŸ› ï¸ Admin â€“ Táº¡o CÃ¢u Há»i</div>
</div>

<!-- ================= CHá»ŒN CHá»¦ Äá»€ ================= -->
<div class="admin-topic-select">
  <div class="ui-card">
    <h3>HÃ£y chá»n chá»§ Ä‘á»!</h3>

    <!-- ===== Cáº¤P 1 ===== -->
    <div class="rowline">
      <div class="title">Chá»§ Ä‘á» 1:</div>

      <form method="GET" action="/admin/questions" class="row-form">
        <select name="folder1_id" required onchange="this.form.submit()">
          {% for f in folder1_list %}
            <option value="{{ f.id }}"
              {% if selected_folder1 and selected_folder1.id == f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>
      </form>

      <div class="actions">
        <button class="admin-btn btn-add"
                data-open="modalFolder"
                data-level="1"
                data-action="add">
          â• ThÃªm
        </button>

        {% if selected_folder1 %}
          <button class="admin-btn btn-edit"
                  data-open="modalFolder"
                  data-level="1"
                  data-action="edit">
            âœï¸ Sá»­a
          </button>

          <form method="POST"
                action="/admin/folder/{{ selected_folder1.id }}/delete"
                onsubmit="return confirm('XoÃ¡ Chá»§ Ä‘á» 1?');">
            <button class="admin-btn ui-btn--gray">ğŸ—‘ï¸ XoÃ¡</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- ===== Cáº¤P 2 ===== -->
    <div class="rowline">
      <div class="title">Chá»§ Ä‘á» 2:</div>

      <form method="GET" action="/admin/questions" class="row-form">
        <input type="hidden" name="folder1_id" value="{{ selected_folder1.id if selected_folder1 else '' }}">
        <select name="folder2_id" required onchange="this.form.submit()">
          {% for f in folder2_list %}
            <option value="{{ f.id }}"
              {% if selected_folder2 and selected_folder2.id == f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>
      </form>

      <div class="actions">
        <button class="admin-btn btn-add"
                data-open="modalFolder"
                data-level="2"
                data-action="add"
                data-parent-id="{{ selected_folder1.id if selected_folder1 }}">
          â• ThÃªm
        </button>

        {% if selected_folder2 %}
          <button class="admin-btn btn-edit"
                  data-open="modalFolder"
                  data-level="2"
                  data-action="edit">
            âœï¸ Sá»­a
          </button>

          <form method="POST"
                action="/admin/folder/{{ selected_folder2.id }}/delete"
                onsubmit="return confirm('XoÃ¡ Chá»§ Ä‘á» 2?');">
            <button class="admin-btn ui-btn--gray">ğŸ—‘ï¸ XoÃ¡</button>
          </form>
        {% endif %}
      </div>
    </div>

    <!-- ===== Cáº¤P 3 ===== -->
    <div class="rowline">
      <div class="title">Chá»§ Ä‘á» 3:</div>

      <form method="GET" action="/admin/questions" class="row-form">
        <input type="hidden" name="folder1_id" value="{{ selected_folder1.id if selected_folder1 else '' }}">
        <input type="hidden" name="folder2_id" value="{{ selected_folder2.id if selected_folder2 else '' }}">
        <select name="folder3_id" required onchange="this.form.submit()">
          {% for f in folder3_list %}
            <option value="{{ f.id }}"
              {% if selected_folder3 and selected_folder3.id == f.id %}selected{% endif %}>
              {{ f.name }}
            </option>
          {% endfor %}
        </select>
      </form>

      <div class="actions">
        <button class="admin-btn btn-add"
                data-open="modalFolder"
                data-level="3"
                data-action="add"
                data-parent-id="{{ selected_folder2.id if selected_folder2 }}">
          â• ThÃªm
        </button>

        {% if selected_folder3 %}
          <button class="admin-btn btn-edit"
                  data-open="modalFolder"
                  data-level="3"
                  data-action="edit">
            âœï¸ Sá»­a
          </button>

          <form method="POST"
                action="/admin/folder/{{ selected_folder3.id }}/delete"
                onsubmit="return confirm('XoÃ¡ Chá»§ Ä‘á» 3?');">
            <button class="admin-btn ui-btn--gray">ğŸ—‘ï¸ XoÃ¡</button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<!-- ================= DANH SÃCH CÃ‚U Há»I ================= -->
{% if selected_folder3 %}
<div class="admin-question-header">
  <div class="question-header-app-content">

    <div class="question-header">
      <div class="qh-left">
        <h2>ğŸ“Œ {{ selected_folder1.name }} â€” {{ selected_folder2.name }} â€” {{ selected_folder3.name }}</h2>
        <div class="badge">{{ questions|length }} cÃ¢u</div>
      </div>
      <div class="qh-right">
        <button class="ui-btn" data-open="modalAddQuestion">
          â• ThÃªm cÃ¢u há»i
        </button>
      </div>
    </div>

    {% for q in questions %}
    <div class="admin-question-item color-{{ loop.index0 % 3 }}">

      <div class="question-text">
        <b>#{{ q.id }}</b> â€” {{ q.text }}
      </div>

      <div class="question-actions">
        <a class="admin-btn btn-edit"
           href="/admin/question/{{ q.id }}/edit">
           âœï¸ Sá»­a
        </a>

        <form method="POST"
              action="/admin/question/{{ q.id }}/delete"
              onsubmit="return confirm('XoÃ¡ cÃ¢u há»i nÃ y?');">
          <button class="admin-btn ui-btn--gray">ğŸ—‘ï¸ XoÃ¡</button>
        </form>
      </div>

    </div>
    {% endfor %}


  </div>
</div>
{% endif %}

<!-- ================= MODAL FOLDER ================= -->
<div class="ui-modal-backdrop" id="modalFolder">
  <div class="ui-modal-box ui-modal-admin">
    <div class="ui-modal-header">
      <div class="modal-title" id="folderModalTitle"></div>
      <button class="icon-btn" type="button" data-close="modalFolder">âœ–</button>
    </div>

    <form method="POST" id="folderForm" enctype="multipart/form-data">
      <div class="ui-modal-body">
        <input type="hidden" name="level" id="folderLevel">
        <input type="hidden" name="folder_id" id="folderId">
        <input type="hidden" name="parent_id" id="folderParentId">

        <div class="form-row">
          <label>TÃªn chá»§ Ä‘á»</label>
          <input name="name" id="folderName" required>
        </div>

        <div class="form-row">
          <label>áº¢nh Ä‘áº¡i diá»‡n</label>
          <input type="file" name="image" accept="image/*">
        </div>
      </div>

      <div class="ui-modal-footer">
        <button type="button" class="admin-btn ui-btn--gray" data-close="modalFolder">Huá»·</button>
        <button type="submit" class="admin-btn btn-add">ğŸ’¾ LÆ°u</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= MODAL ADD QUESTION (NEW UI) ================= -->
<div class="ui-modal-backdrop" id="modalAddQuestion">
  <div class="ui-modal-box ui-modal-admin" style="max-width:640px;">
    <div class="ui-modal-header">
      <div class="modal-title">â• ThÃªm cÃ¢u há»i</div>
      <button class="icon-btn" type="button" data-close="modalAddQuestion">âœ–</button>
    </div>

    <div class="ui-modal-body">

      <!-- CHá»¦ Äá»€ -->
      <div class="edit-question-topic">
        ğŸ“Œ {{ selected_folder1.name }}
        â€” {{ selected_folder2.name }}
        â€” {{ selected_folder3.name }}
      </div>

      <form method="POST" action="/admin/questions" class="admin-form-card" style="box-shadow:none;padding:0;">
        <input type="hidden" name="folder3_id" value="{{ selected_folder3.id }}">

        <!-- CÃ‚U Há»I -->
        <div class="form-row">
          <label>CÃ¢u há»i</label>
          <textarea name="question_text" rows="3" required></textarea>
        </div>

        <!-- ÄÃP ÃN -->
        <div class="form-row">
          <label>ÄÃ¡p Ã¡n A</label>
          <input name="choice1" required>
        </div>

        <div class="form-row">
          <label>ÄÃ¡p Ã¡n B</label>
          <input name="choice2" required>
        </div>

        <div class="form-row">
          <label>ÄÃ¡p Ã¡n C</label>
          <input name="choice3" required>
        </div>

        <div class="form-row">
          <label>ÄÃ¡p Ã¡n D</label>
          <input name="choice4" required>
        </div>

        <!-- ÄÃP ÃN ÄÃšNG -->
        <div class="form-row">
          <label>ÄÃ¡p Ã¡n Ä‘Ãºng</label>
          <div class="answer-box">
            {% for k in ["A","B","C","D"] %}
              <label class="answer-item">
                <input type="radio" name="correct" value="{{ k }}" required>
                {{ k }}
              </label>
            {% endfor %}
          </div>
        </div>

        <!-- ACTION -->
        <div class="form-actions">
          <button type="button"
                  class="admin-btn ui-btn--gray"
                  data-close="modalAddQuestion">
            Huá»·
          </button>

          <button type="submit" class="ui-btn">
            ğŸ’¾ LÆ°u
          </button>
        </div>

      </form>
    </div>
  </div>
</div>




<!-- ================= SCRIPT ================= -->
<script>
document.addEventListener("click", e => {
  const open = e.target.closest("[data-open]");
  if (open) {
    e.preventDefault();
    const modalId = open.dataset.open;
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // =========================
    // MODAL FOLDER (ADD / EDIT)
    // =========================
    if (modalId === "modalFolder") {
      const form = document.getElementById("folderForm");
      const level = open.dataset.level;
      const actionType = open.dataset.action;

      // reset form
      form.reset();

      // set level
      document.getElementById("folderLevel").value = level;

      // set parent_id náº¿u cÃ³
      document.getElementById("folderParentId").value =
        open.dataset.parentId || "";

      // ADD
      if (actionType === "add") {
        form.action = "/admin/folder/add";
        document.getElementById("folderId").value = "";
        document.getElementById("folderModalTitle").innerText = "â• ThÃªm chá»§ Ä‘á»";
      }

      // EDIT
      if (actionType === "edit") {
        let folderId = "";
        let folderName = "";

        if (level === "1") {
          folderId = "{{ selected_folder1.id if selected_folder1 else '' }}";
          folderName = "{{ selected_folder1.name if selected_folder1 else '' }}";
        }
        if (level === "2") {
          folderId = "{{ selected_folder2.id if selected_folder2 else '' }}";
          folderName = "{{ selected_folder2.name if selected_folder2 else '' }}";
        }
        if (level === "3") {
          folderId = "{{ selected_folder3.id if selected_folder3 else '' }}";
          folderName = "{{ selected_folder3.name if selected_folder3 else '' }}";
        }

        form.action = `/admin/folder/${folderId}/edit`;
        document.getElementById("folderId").value = folderId;
        document.getElementById("folderName").value = folderName;
        document.getElementById("folderModalTitle").innerText = "âœï¸ Sá»­a chá»§ Ä‘á»";
      }
    }

    // reset radio khi má»Ÿ modal thÃªm cÃ¢u há»i
    if (modalId === "modalAddQuestion") {
      modal
        .querySelectorAll("input[type=radio]")
        .forEach(r => r.checked = false);
    }

    modal.classList.add("show");
    document.body.style.overflow = "hidden";
  }

  const close = e.target.closest("[data-close]");
  if (close) {
    document.getElementById(close.dataset.close)?.classList.remove("show");
    document.body.style.overflow = "";
  }
});
</script>

{% endblock %}
